<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>King Shot Troop Calculator</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 1rem;
      max-width: 400px;
      margin: auto;
    }
    input {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 0.8rem;
      font-size: 1rem;
    }
    select {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 0.8rem;
      font-size: 1rem;
    }
    .march-block {
      border: 1px solid #ccc;
      padding: 0.6rem;
      margin-top: 0.8rem;
      border-radius: 6px;
    }
    button {
      width: 100%;
      padding: 0.8rem;
      font-size: 1.1rem;
    }
    .result {
      margin-top: 1rem;
      font-weight: bold;
    }
    .toggle {
      margin: 1rem 0;
      padding: 0.6rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f9f9f9;

      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
  </style>
</head>
<body>

<h2>King Shot Troop Calculator</h2>

<input id="troops" type="number" placeholder="Total Troops">
<input id="marches" type="number" placeholder="Total Marches">

<div class="toggle">
  <input type="checkbox" id="sameRatio" checked>
  <label for="sameRatio">Same Ratio per March</label>
</div>

<div id="marchRatios"></div>
  
<div id="mainRatios">
  <label>Inf %</label>
  <select id="inf"></select>

  <label>Cav %</label>
  <select id="cav"></select>

  <label>Archer %</label>
  <select id="arch"></select>
</div>

<button onclick="calculate()">Calculate</button>
<button onclick="resetCalculator()">Reset</button>
  
<div class="result" id="output"></div>

<script>
function createRatioSelect(id) {
  const select = document.createElement("select");
  select.id = id;

  for (let i = 0; i <= 100; i += 10) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = i + "%";
    select.appendChild(option);
  }

  select.addEventListener("change", calculate);
  return select;
}

function populateMainRatios() {
  document.getElementById("inf").replaceWith(createRatioSelect("inf"));
  document.getElementById("cav").replaceWith(createRatioSelect("cav"));
  document.getElementById("arch").replaceWith(createRatioSelect("arch"));

  document.getElementById("inf").value = 40;
  document.getElementById("cav").value = 30;
  document.getElementById("arch").value = 30;
}

function buildMarchRatios() {
  const container = document.getElementById("marchRatios");
  container.innerHTML = "";

  const marches = Number(document.getElementById("marches").value);
  if (!marches || marches < 1) return;

  for (let i = 1; i <= marches; i++) {
    const block = document.createElement("div");
    block.className = "march-block";

    // 1️ Create <details>
    const details = document.createElement("details");

    // 2️ Create <summary>
    const summary = document.createElement("summary");
    summary.textContent = `March ${i}`;

    // 3️ Create selects
    const inf = createRatioSelect(`m${i}-inf`);
    const cav = createRatioSelect(`m${i}-cav`);
    const arch = createRatioSelect(`m${i}-arch`);

    inf.value = 40;
    cav.value = 30;
    arch.value = 30;

    // 4 Assemble hierarchy
    details.appendChild(summary);
    details.append(
    "Infantry", inf, document.createElement("br"),
    "Cavalry", cav, document.createElement("br"),
     "Archers", arch
    );
    block.appendChild(details);
    container.appendChild(block);
  }
}

function ratiosValid(inf, cav, arch) {
  return Math.abs(inf + cav + arch - 1) < 0.0001;
}

function calculate() {
  const troops = Number(document.getElementById("troops").value);
  const marches = Number(document.getElementById("marches").value);
  const sameRatio = document.getElementById("sameRatio").checked;
  const output = document.getElementById("output");

  if (!troops || !marches) {
    output.innerText = "";
    return;
  }

  let result = "";
  let usedTroops = 0;
  const perMarch = Math.floor(troops / marches);

if (sameRatio) {
  const infRatio = document.getElementById("inf").value / 100;
  const cavRatio = document.getElementById("cav").value / 100;
  const archRatio = document.getElementById("arch").value / 100;

  if (!ratiosValid(infRatio, cavRatio, archRatio)) {
    output.innerText = "Ratios must add up to 100%.";
    return;
  }

  const i = Math.floor(perMarch * infRatio);
  const c = Math.floor(perMarch * cavRatio);
  const a = Math.floor(perMarch * archRatio);

    usedTroops = (i + c + a) * marches;

    result += `
      Per March: ${perMarch}<br>
      Infantry: ${i}<br>
      Cavalry: ${c}<br>
      Archers: ${a}<br>
    `;
  } else {
    for (let i = 1; i <= marches; i++) {
      const inf = document.getElementById(`m${i}-inf`).value / 100;
      const cav = document.getElementById(`m${i}-cav`).value / 100;
      const arch = document.getElementById(`m${i}-arch`).value / 100;

      if (!ratiosValid(inf, cav, arch)) {
        output.innerText = `March ${i} ratios must add to 100%.`;
        return;
      }

      const ti = Math.floor(perMarch * inf);
      const tc = Math.floor(perMarch * cav);
      const ta = Math.floor(perMarch * arch);

      usedTroops += ti + tc + ta;

      result += `
        <strong>March ${i}</strong><br>
        Infantry: ${ti}<br>
        Cavalry: ${tc}<br>
        Archers: ${ta}<br><br>
      `;
    }
  }

  const leftover = troops - usedTroops;
  if (leftover > 0) {
    result += `<br>⚠️ Leftover Troops: ${leftover}`;
  }

  output.innerHTML = result;
}

function resetCalculator() {
  document.getElementById("troops").value = "";
  document.getElementById("marches").value = "";
  document.getElementById("sameRatio").checked = true;
  document.getElementById("marchRatios").innerHTML = "";
  populateMainRatios();
  document.getElementById("output").innerText = "";
}

document.getElementById("marches").addEventListener("change", () => {
  if (!document.getElementById("sameRatio").checked) {
    buildMarchRatios();
  }
  calculate();
});

document.getElementById("sameRatio").addEventListener("change", () => {
  const sameRatio = document.getElementById("sameRatio").checked;
  const mainRatios = document.getElementById("mainRatios");
  const marchRatios = document.getElementById("marchRatios");

  mainRatios.style.display = sameRatio ? "block" : "none";
  marchRatios.innerHTML = "";

  if (!sameRatio) buildMarchRatios();
  calculate();
});

// Initial setup
populateMainRatios();

// Sync UI with checkbox state on load
document.getElementById("mainRatios").style.display =
  document.getElementById("sameRatio").checked ? "block" : "none";
</script>
</body>
</html>
